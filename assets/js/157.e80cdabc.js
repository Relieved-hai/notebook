(window.webpackJsonp=window.webpackJsonp||[]).push([[157],{1276:function(t,e,s){"use strict";s.r(e);var a=s(19),r=Object(a.a)({},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"fetch：跨源请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fetch：跨源请求","aria-hidden":"true"}},[t._v("#")]),t._v(" Fetch：跨源请求")]),t._v(" "),a("p",[t._v("如果我们向另一个网站发送 "),a("code",[t._v("fetch")]),t._v(" 请求，则该请求可能会失败。")]),t._v(" "),a("p",[t._v("例如，让我们尝试向 "),a("code",[t._v("http://example.com")]),t._v(" 发送 "),a("code",[t._v("fetch")]),t._v(" 请求：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://example.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// fetch 失败")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("正如所料，获取失败。")]),t._v(" "),a("p",[t._v("这里的核心概念是 "),a("strong",[t._v("源（origin）")]),t._v(" —— 域（domain）/端口（port）/协议（protocol）的组合。")]),t._v(" "),a("p",[t._v("跨源请求 —— 那些发送到其他域（即使是子域）、协议或端口的请求 —— 需要来自远程端的特殊 header。")]),t._v(" "),a("p",[t._v("这个策略被称为 “CORS”：跨源资源共享（Cross-Origin Resource Sharing）。")]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"为什么需要-cors？跨源请求简史"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要-cors？跨源请求简史","aria-hidden":"true"}},[t._v("#")]),t._v(" 为什么需要 CORS？跨源请求简史")]),t._v(" "),a("p",[t._v("CORS 的存在是为了保护互联网免受黑客攻击。")]),t._v(" "),a("p",[t._v("说真的，在这说点儿题外话，讲讲它的历史。")]),t._v(" "),a("p",[a("strong",[t._v("多年来，来自一个网站的脚本无法访问另一个网站的内容。")])]),t._v(" "),a("p",[t._v("这个简单有力的规则是互联网安全的基础。例如，来自 "),a("code",[t._v("hacker.com")]),t._v(" 的脚本无法访问 "),a("code",[t._v("gmail.com")]),t._v(" 上的用户邮箱。基于这样的规则，人们感到很安全。")]),t._v(" "),a("p",[t._v("在那时候，JavaScript 并没有任何特殊的执行网络请求的方法。它只是一种用来装饰网页的玩具语言而已。")]),t._v(" "),a("p",[t._v("但是 Web 开发人员需要更多功能。人们发明了各种各样的技巧去突破该限制，并向其他网站发出请求。")]),t._v(" "),a("br"),t._v(" "),a("h3",{attrs:{id:"使用表单"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用表单","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用表单")]),t._v(" "),a("p",[t._v("其中一种和其他服务器通信的方法是在那里提交一个 "),a("code",[t._v("<form>")]),t._v("。人们将它提交到 "),a("code",[t._v("<iframe>")]),t._v("，只是为了停留在当前页面，像这样：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" 表单目标 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("iframe name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"iframe"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("iframe"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" 表单可以由 JavaScript 动态生成并提交 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("form target"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"iframe"')]),t._v(" method"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"POST"')]),t._v(" action"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://another.com/…"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("form"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("因此，即使没有网络方法，也可以向其他网站发出 GET/POST 请求，因为表单可以将数据发送到任何地方。但是由于禁止从其他网站访问 "),a("code",[t._v("<iframe>")]),t._v(" 中的内容，因此就无法读取响应。")]),t._v(" "),a("p",[t._v("确切地说，实际上有一些技巧能够解决这个问题，这在 iframe 和页面中都需要添加特殊脚本。因此，与 iframe 的通信在技术上是可能的。现在我们没必要讲其细节内容，我们还是让这些古董代码不要再出现了吧。")]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h3",{attrs:{id:"使用-script"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-script","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用 script")]),t._v(" "),a("p",[t._v("另一个技巧是使用 "),a("code",[t._v("script")]),t._v(" 标签。"),a("code",[t._v("script")]),t._v(" 可以具有任何域的 "),a("code",[t._v("src")]),t._v("，例如 "),a("code",[t._v('<script src="http://another.com/…">')]),t._v("。也可以执行来自任何网站的 "),a("code",[t._v("script")]),t._v("。")]),t._v(" "),a("p",[t._v("如果一个网站，例如 "),a("code",[t._v("another.com")]),t._v(" 试图公开这种访问方式的数据，则会使用所谓的 “JSONP (JSON with padding)” 协议。")]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("这是它的工作方式。")]),t._v(" "),a("p",[t._v("假设在我们的网站，需要以这种方式从 "),a("code",[t._v("http://another.com")]),t._v(" 网站获取数据，例如天气：")]),t._v(" "),a("ul",[a("li",[a("ol",[a("li",[t._v("首先，我们先声明一个全局函数来接收数据，例如 "),a("code",[t._v("gotWeather")]),t._v("。")])])])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 声明处理天气数据的函数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("gotWeather")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" temperature"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" humidity "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`temperature: ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("temperature"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(", humidity: ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("humidity"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("ul",[a("li",[a("ol",{attrs:{start:"2"}},[a("li",[t._v("然后我们创建一个特性（attribute）为 "),a("code",[t._v('src="http://another.com/weather.json?callback=gotWeather"')]),t._v(" 的 "),a("code",[t._v("<script>")]),t._v(" 标签，使用我们的函数名作为它的 "),a("code",[t._v("callback")]),t._v(" URL-参数。")])])])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" script "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'script'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nscript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`http://another.com/weather.json?callback=gotWeather`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ndocument"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("ul",[a("li",[a("ol",{attrs:{start:"3"}},[a("li",[t._v("远程服务器 "),a("code",[t._v("another.com")]),t._v(" 动态生成一个脚本，该脚本调用 "),a("code",[t._v("gotWeather(...)")]),t._v("，发送它想让我们接收的数据。")])])])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 我们期望来自服务器的回答看起来像这样：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("gotWeather")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  temperature"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  humidity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("78")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("ul",[a("li",[a("ol",{attrs:{start:"4"}},[a("li",[t._v("当远程脚本加载并执行时，"),a("code",[t._v("gotWeather")]),t._v(" 函数将运行，并且因为它是我们的函数，我们就有了需要的数据。")])])])]),t._v(" "),a("p",[t._v("这是可行的，并且不违反安全规定，因为双方都同意以这种方式传递数据。而且，既然双方都同意这种行为，那这肯定不是黑客攻击了。现在仍然有提供这种访问的服务，因为即使是非常旧的浏览器它依然适用。")]),t._v(" "),a("p",[t._v("不久之后，网络方法出现在了浏览器 JavaScript 中。")]),t._v(" "),a("p",[t._v("起初，跨源请求是被禁止的。但是，经过长时间的讨论，跨源请求被允许了，但是任何新功能都需要服务器明确允许，以特殊的 header 表述。")]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"简单的请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单的请求","aria-hidden":"true"}},[t._v("#")]),t._v(" 简单的请求")]),t._v(" "),a("p",[t._v("有两种类型的跨源请求：")]),t._v(" "),a("ul",[a("li",[a("ol",[a("li",[t._v("简单的请求。")])])]),t._v(" "),a("li",[a("ol",{attrs:{start:"2"}},[a("li",[t._v("所有其他请求。")])])])]),t._v(" "),a("p",[t._v("顾名思义，简单的请求很简单，所以我们先从它开始。")]),t._v(" "),a("p",[t._v("一个 "),a("a",{attrs:{href:"https://fetch.spec.whatwg.org/#terminology",target:"_blank",rel:"noopener noreferrer"}},[t._v("简单的请求"),a("OutboundLink")],1),t._v(" 是指满足以下两个条件的请求：")]),t._v(" "),a("ul",[a("li",[a("ol",[a("li",[a("a",{attrs:{href:"https://fetch.spec.whatwg.org/#simple-method",target:"_blank",rel:"noopener noreferrer"}},[t._v("简单的方法"),a("OutboundLink")],1),t._v(" ：GET，POST 或 HEAD")])])]),t._v(" "),a("li",[a("ol",{attrs:{start:"2"}},[a("li",[a("a",{attrs:{href:"https://fetch.spec.whatwg.org/#simple-header",target:"_blank",rel:"noopener noreferrer"}},[t._v("简单的 header"),a("OutboundLink")],1),t._v(" —— 仅允许自定义下列 header：")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Accept")]),t._v("，")]),t._v(" "),a("li",[a("code",[t._v("Accept-Language")]),t._v("，")]),t._v(" "),a("li",[a("code",[t._v("Content-Language")]),t._v("，")]),t._v(" "),a("li",[a("code",[t._v("Content-Type")]),t._v(" 的值为 "),a("code",[t._v("application/x-www-form-urlencoded")]),t._v("，"),a("code",[t._v("multipart/form-data")]),t._v(" 或 "),a("code",[t._v("text/plain")]),t._v("。")])])])]),t._v(" "),a("p",[t._v("任何其他请求都被认为是“非简单请求”。例如，具有 "),a("code",[t._v("PUT")]),t._v(" 方法或 "),a("code",[t._v("API-Key")]),t._v(" HTTP-header 的请求就不是简单请求。")]),t._v(" "),a("br"),t._v(" "),a("p",[a("strong",[t._v("本质区别在于，可以使用 "),a("code",[t._v("<form>")]),t._v(" 或 "),a("code",[t._v("<script>")]),t._v(" 进行“简单请求”，而无需任何其他特殊方法。")])]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("因此，即使是非常旧的服务器也能很好地接收简单请求。")]),t._v(" "),a("p",[t._v("与此相反，带有非标准 header 或者例如 "),a("code",[t._v("DELETE")]),t._v(" 方法的请求，无法通过这种方式创建。在很长一段时间里，JavaScript 都不能进行这样的请求。所以，旧的服务器可能会认为此类请求来自具有特权的来源（privileged source），“因为网页无法发送它们”。")]),t._v(" "),a("p",[t._v("当我们尝试发送一个非简单请求时，浏览器会发送一个特殊的“预检（preflight）”请求到服务器 —— 询问服务器，你接受此类跨源请求吗？")]),t._v(" "),a("p",[t._v("并且，除非服务器明确通过 header 进行确认，否则非简单请求不会被发送。")]),t._v(" "),a("p",[t._v("现在，我们来详细介绍它们。")]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"用于简单请求的-cors"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用于简单请求的-cors","aria-hidden":"true"}},[t._v("#")]),t._v(" 用于简单请求的 CORS")]),t._v(" "),a("p",[t._v("如果一个请求是跨源的，浏览器始终会向其添加 "),a("code",[t._v("Origin")]),t._v(" header。")]),t._v(" "),a("p",[t._v("例如，如果我们从 "),a("code",[t._v("https://relieved-hai.github.io/page")]),t._v(" 请求 "),a("code",[t._v("https://anywhere.com/request")]),t._v("，请求的 header 将会如下：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("GET /request\nHost: anywhere.com\nOrigin: https://relieved-hai.github.io\n...\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("正如你所见，"),a("code",[t._v("Origin")]),t._v(" 包含了确切的源（domain/protocol/port），没有路径。")]),t._v(" "),a("p",[t._v("服务器可以检查 "),a("code",[t._v("Origin")]),t._v("，如果同意接受这样的请求，就会在响应中添加一个特殊的 header "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v("。该 header 包含了允许的源（在我们的示例中是 "),a("code",[t._v("https://relieved-hai.github.io")]),t._v("），或者一个星号 "),a("code",[t._v("*")]),t._v("。然后响应成功，否则报错。")]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("浏览器在这里扮演受被信任的中间人的角色：")]),t._v(" "),a("ul",[a("li",[a("ol",[a("li",[t._v("它确保发送的跨源请求带有正确的 "),a("code",[t._v("Origin")]),t._v("。")])])]),t._v(" "),a("li",[a("ol",{attrs:{start:"2"}},[a("li",[t._v("它检查响应中的许可 "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v("，如果存在，则允许 JavaScript 访问响应，否则将失败并报错。")])])])]),t._v(" "),a("p",[a("img",{attrs:{src:s(699),alt:""}})]),t._v(" "),a("p",[t._v("这是一个带有服务器许可的响应示例：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("200 OK\nContent-Type:text/html; charset=UTF-8\nAccess-Control-Allow-Origin: https://relieved-hai.github.io\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("br"),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"response-header"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#response-header","aria-hidden":"true"}},[t._v("#")]),t._v(" Response header")]),t._v(" "),a("p",[t._v("对于跨源请求，默认情况下，JavaScript 只能访问“简单” response header：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Cache-Control")])]),t._v(" "),a("li",[a("code",[t._v("Content-Language")])]),t._v(" "),a("li",[a("code",[t._v("Content-Type")])]),t._v(" "),a("li",[a("code",[t._v("Expires")])]),t._v(" "),a("li",[a("code",[t._v("Last-Modified")])]),t._v(" "),a("li",[a("code",[t._v("Pragma")])])]),t._v(" "),a("p",[t._v("访问任何其他 response header 都将导致 error。")]),t._v(" "),a("div",{staticClass:"tip custom-block"},[a("p",[a("strong",[t._v("请注意：")])]),t._v(" "),a("p",[t._v("请注意：列表中没有 "),a("code",[t._v("Content-Length")]),t._v(" header！")]),t._v(" "),a("p",[t._v("该 header 包含完整的响应长度。因此，如果我们正在下载某些内容，并希望跟踪进度百分比，则需要额外的权限才能访问该 header（请见下文）。")])]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("要授予 JavaScript 对任何其他 response header 的访问权限，服务器必须发送 "),a("code",[t._v("Access-Control-Expose-Headers")]),t._v(" header。它包含一个以逗号分隔的应该被设置为可访问的非简单 header 名称列表。")]),t._v(" "),a("p",[t._v("例如：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("200 OK\nContent-Type:text/html; charset=UTF-8\nContent-Length: 12345\nAPI-Key: 2c9de507f2c54aa1\nAccess-Control-Allow-Origin: https://relieved-hai.github.io\nAccess-Control-Expose-Headers: Content-Length,API-Key\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("有了这种 "),a("code",[t._v("Access-Control-Expose-Headers")]),t._v(" header，此脚本就被允许读取响应的 "),a("code",[t._v("Content-Length")]),t._v(" 和 "),a("code",[t._v("API-Key")]),t._v(" header。")]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"“非简单”请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#“非简单”请求","aria-hidden":"true"}},[t._v("#")]),t._v(" “非简单”请求")]),t._v(" "),a("p",[t._v("我们可以使用任何 HTTP 方法：不仅仅是 "),a("code",[t._v("GET/POST")]),t._v("，也可以是 "),a("code",[t._v("PATCH")]),t._v("，"),a("code",[t._v("DELETE")]),t._v(" 及其他。")]),t._v(" "),a("p",[t._v("之前，没有人能够设想网页能发出这样的请求。因此，可能仍然存在有些 Web 服务将非标准方法视为一个信号：“这不是浏览器”。它们可以在检查访问权限时将其考虑在内。")]),t._v(" "),a("p",[t._v("因此，为了避免误解，任何“非标准”请求 —— 浏览器不会立即发出在过去无法完成的这类请求。即在它发送这类请求前，会先发送“预检（preflight）”请求来请求许可。")]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("预检请求使用 "),a("code",[t._v("OPTIONS")]),t._v(" 方法，它没有 body，但是有两个 header：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Access-Control-Request-Method")]),t._v(" header 带有非简单请求的方法。")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Request-Headers")]),t._v(" header 提供一个以逗号分隔的非简单 HTTP-header 列表。")])]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("如果服务器同意处理请求，那么它会进行响应，此响应的状态码应该为 200，没有 body，具有 header：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 必须为 "),a("code",[t._v("*")]),t._v(" 或进行请求的源（例如 "),a("code",[t._v("https://relieved-hai.github.io")]),t._v("）才能允许此请求。")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Allow-Methods")]),t._v(" 必须具有允许的方法。")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Allow-Headers")]),t._v(" 必须具有一个允许的 header 列表。")]),t._v(" "),a("li",[t._v("另外，header "),a("code",[t._v("Access-Control-Max-Age")]),t._v(" 可以指定缓存此权限的秒数。因此，浏览器不是必须为满足给定权限的后续请求发送预检。")])]),t._v(" "),a("p",[a("img",{attrs:{src:s(700),alt:""}})]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("让我们用一个例子来一步步看一下它是怎么工作的，对于一个跨源的 "),a("code",[t._v("PATCH")]),t._v(" 请求（此方法经常被用于更新数据）：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" response "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://site.com/service.json'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  method"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'PATCH'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  headers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'API-Key'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'secret'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("这里有三个理由解释为什么它不是一个简单请求（其实一个就够了）：")]),t._v(" "),a("ul",[a("li",[t._v("方法 "),a("code",[t._v("PATCH")])]),t._v(" "),a("li",[a("code",[t._v("Content-Type")]),t._v(" 不是这三个中之一："),a("code",[t._v("application/x-www-form-urlencoded")]),t._v("，"),a("code",[t._v("multipart/form-data")]),t._v("，"),a("code",[t._v("text/plain")]),t._v("。")]),t._v(" "),a("li",[t._v("“非简单” "),a("code",[t._v("API-Key")]),t._v(" header。")])]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"step-1-预检请求（preflight-request）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-1-预检请求（preflight-request）","aria-hidden":"true"}},[t._v("#")]),t._v(" Step 1 预检请求（preflight request）")]),t._v(" "),a("p",[t._v("在发送我们的请求前，浏览器会自己发送如下所示的预检请求：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("OPTIONS /service.json\nHost: site.com\nOrigin: https://relieved-hai.github.io\nAccess-Control-Request-Method: PATCH\nAccess-Control-Request-Headers: Content-Type,API-Key\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("ul",[a("li",[t._v("方法："),a("code",[t._v("OPTIONS")]),t._v("。")]),t._v(" "),a("li",[t._v("路径 —— 与主请求完全相同："),a("code",[t._v("/service.json")]),t._v("。")]),t._v(" "),a("li",[t._v("特殊跨源头：\n"),a("ul",[a("li",[a("code",[t._v("Origin")]),t._v(" —— 来源。")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Request-Method")]),t._v(" —— 请求方法。")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Request-Headers")]),t._v(" —— 以逗号分隔的“非简单” header 列表。")])])])]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"step-2-预检响应（preflight-response）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-2-预检响应（preflight-response）","aria-hidden":"true"}},[t._v("#")]),t._v(" Step 2 预检响应（preflight response）")]),t._v(" "),a("p",[t._v("服务应响应状态 200 和 header：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Access-Control-Allow-Origin: https://relieved-hai.github.io")])]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Allow-Methods: PATCH")])]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Allow-Headers: Content-Type,API-Key")]),t._v("。")])]),t._v(" "),a("p",[t._v("这将允许后续通信，否则会触发错误。")]),t._v(" "),a("p",[t._v("如果服务器将来期望其他方法和 header，则可以通过将这些方法和 header 添加到列表中来预先允许它们。")]),t._v(" "),a("p",[t._v("例如，此响应还允许 "),a("code",[t._v("PUT")]),t._v("、"),a("code",[t._v("DELETE")]),t._v(" 以及其他 header：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("200 OK\nAccess-Control-Allow-Origin: https://relieved-hai.github.io\nAccess-Control-Allow-Methods: PUT,PATCH,DELETE\nAccess-Control-Allow-Headers: API-Key,Content-Type,If-Modified-Since,Cache-Control\nAccess-Control-Max-Age: 86400\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("现在，浏览器可以看到 "),a("code",[t._v("PATCH")]),t._v(" 在 "),a("code",[t._v("Access-Control-Allow-Methods")]),t._v(" 中，"),a("code",[t._v("Content-Type,API-Key")]),t._v(" 在列表 "),a("code",[t._v("Access-Control-Allow-Headers")]),t._v(" 中，因此它将发送主请求。")]),t._v(" "),a("p",[t._v("如果 "),a("code",[t._v("Access-Control-Max-Age")]),t._v(" 带有一个表示秒的数字，则在给定的时间内，预检权限会被缓存。上面的响应将被缓存 86400 秒，也就是一天。在此时间范围内，后续请求将不会触发预检。假设它们符合缓存的配额，则将直接发送它们。")]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"step-3-实际请求（actual-request）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-3-实际请求（actual-request）","aria-hidden":"true"}},[t._v("#")]),t._v(" Step 3 实际请求（actual request）")]),t._v(" "),a("p",[t._v("预检成功后，浏览器现在发出主请求。这里的算法与简单请求的算法相同。")]),t._v(" "),a("p",[t._v("主请求具有 "),a("code",[t._v("Origin")]),t._v(" header（因为它是跨源的）：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("PATCH /service.json\nHost: site.com\nContent-Type: application/json\nAPI-Key: secret\nOrigin: https://relieved-hai.github.io\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"step-4-实际响应（actual-response）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-4-实际响应（actual-response）","aria-hidden":"true"}},[t._v("#")]),t._v(" Step 4 实际响应（actual response）")]),t._v(" "),a("p",[t._v("服务器不应该忘记在主响应中添加 "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v("。成功的预检并不能免除此要求：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Access-Control-Allow-Origin: https://relieved-hai.github.io\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("然后，JavaScript 可以读取主服务器响应了。")]),t._v(" "),a("br"),t._v(" "),a("div",{staticClass:"tip custom-block"},[a("p",[a("strong",[t._v("请注意：")])]),t._v(" "),a("p",[t._v("预检请求发生在“幕后”，它对 JavaScript 不可见。")]),t._v(" "),a("p",[t._v("JavaScript 仅获取对主请求的响应，如果没有服务器许可，则获得一个 error。")])]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"凭据（credentials）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#凭据（credentials）","aria-hidden":"true"}},[t._v("#")]),t._v(" 凭据（Credentials）")]),t._v(" "),a("p",[t._v("默认情况下，由 JavaScript 代码发起的跨源请求不会带来任何凭据（cookies 或者 HTTP 认证（HTTP authentication））。")]),t._v(" "),a("p",[t._v("这对于 HTTP 请求来说并不常见。通常，对 "),a("code",[t._v("http://site.com")]),t._v(" 的请求附带有该域的所有 cookie。但是由 JavaScript 方法发出的跨源请求是个例外。")]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("例如，"),a("code",[t._v("fetch('http://another.com')")]),t._v(" 不会发送任何 cookie，即使那些 (!) 属于 "),a("code",[t._v("another.com")]),t._v(" 域的 cookie。")]),t._v(" "),a("p",[t._v("为什么？")]),t._v(" "),a("p",[t._v("这是因为具有凭据的请求比没有凭据的请求要强大得多。如果被允许，它会使用它们的凭据授予 JavaScript 代表用户行为和访问敏感信息的全部权力。")]),t._v(" "),a("p",[t._v("服务器真的这么信任这种脚本吗？是的，它必须显式地带有允许请求的凭据和附加 header。")]),t._v(" "),a("p",[t._v("要在 "),a("code",[t._v("fetch")]),t._v(" 中发送凭据，我们需要添加 "),a("code",[t._v('credentials: "include"')]),t._v(" 选项，像这样：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://another.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"include"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("现在，"),a("code",[t._v("fetch")]),t._v(" 将把源自 "),a("code",[t._v("another.com")]),t._v(" 的 cookie 和我们的请求发送到该网站。")]),t._v(" "),a("p",[t._v("如果服务器同意接受 "),a("strong",[t._v("带有凭据")]),t._v(" 的请求，则除了 "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 外，服务器还应该在响应中添加 header "),a("code",[t._v("Access-Control-Allow-Credentials: true")]),t._v("。")]),t._v(" "),a("p",[t._v("请注意：对于具有凭据的请求，禁止 "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 使用星号 "),a("code",[t._v("*")]),t._v("。如上所示，它必须有一个确切的源。这是另一项安全措施，以确保服务器真的知道它信任的发出此请求的是谁。")]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("从浏览器角度来看，有两种跨源请求：“简单”请求和其他请求。")]),t._v(" "),a("p",[a("a",{attrs:{href:"http://www.w3.org/TR/cors/#terminology",target:"_blank",rel:"noopener noreferrer"}},[t._v("简单请求"),a("OutboundLink")],1),t._v(" 必须满足下列条件：")]),t._v(" "),a("ul",[a("li",[t._v("方法：GET，POST 或 HEAD。")]),t._v(" "),a("li",[t._v("header —— 我们仅能设置：\n"),a("ul",[a("li",[a("code",[t._v("Accept")])]),t._v(" "),a("li",[a("code",[t._v("Accept-Language")])]),t._v(" "),a("li",[a("code",[t._v("Content-Language")])]),t._v(" "),a("li",[a("code",[t._v("Content-Type")]),t._v(" 的值为 "),a("code",[t._v("application/x-www-form-urlencoded")]),t._v("，"),a("code",[t._v("multipart/form-data")]),t._v(" 或 "),a("code",[t._v("text/plain。")])])])])]),t._v(" "),a("br"),t._v(" "),a("p",[t._v("简单请求和其他请求的本质区别在于，自古以来使用 "),a("code",[t._v("<form>")]),t._v(" 或 "),a("code",[t._v("<script>")]),t._v(" 标签进行简单请求就是可行的，而长期以来浏览器都不能进行非简单请求。")]),t._v(" "),a("p",[t._v("所以，实际区别在于，简单请求会使用 "),a("code",[t._v("Origin")]),t._v(" header 并立即发送，而对于其他请求，浏览器会发出初步的“预检”请求，以请求许可。")]),t._v(" "),a("br"),t._v(" "),a("p",[a("strong",[t._v("对于简单请求：")])]),t._v(" "),a("ul",[a("li",[t._v("→ 浏览器发送带有源的 "),a("code",[t._v("Origin")]),t._v(" header。")]),t._v(" "),a("li",[t._v("← 对于没有凭据的请求（默认不发送），服务器应该设置：\n"),a("ul",[a("li",[a("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 为 "),a("code",[t._v("*")]),t._v(" 或与 "),a("code",[t._v("Origin")]),t._v(" 的值相同")])])]),t._v(" "),a("li",[t._v("← 对于具有凭据的请求，服务器应该设置：\n"),a("ul",[a("li",[a("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 值与 "),a("code",[t._v("Origin")]),t._v(" 的相同")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Allow-Credentials")]),t._v(" 为 "),a("code",[t._v("true")])])])])]),t._v(" "),a("p",[t._v("此外，要授予 JavaScript 访问除 "),a("code",[t._v("Cache-Control")]),t._v("，"),a("code",[t._v("Content-Language")]),t._v("，"),a("code",[t._v("Content-Type")]),t._v("，"),a("code",[t._v("Expires")]),t._v("，"),a("code",[t._v("Last-Modified")]),t._v(" 或 "),a("code",[t._v("Pragma")]),t._v(" 外的任何 response header 的权限，服务器应该在 "),a("code",[t._v("header Access-Control-Expose-Headers")]),t._v(" 中列出允许的那些 header。")]),t._v(" "),a("br"),t._v(" "),a("p",[a("strong",[t._v("对于非简单请求，会在请求之前发出初步“预检”请求：")])]),t._v(" "),a("ul",[a("li",[t._v("→ 浏览器将具有以下 header 的 "),a("code",[t._v("OPTIONS")]),t._v(" 请求发送到相同的 URL：\n"),a("ul",[a("li",[a("code",[t._v("Access-Control-Request-Method")]),t._v(" 有请求方法。")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Request-Headers")]),t._v(" 以逗号分隔的“非简单” header 列表。")])])]),t._v(" "),a("li",[t._v("← 服务器应该响应状态码为 200 和 header：\n"),a("ul",[a("li",[a("code",[t._v("Access-Control-Allow-Methods")]),t._v(" 带有允许的方法的列表，")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Allow-Headers")]),t._v(" 带有允许的 header 的列表，")]),t._v(" "),a("li",[a("code",[t._v("Access-Control-Max-Age")]),t._v(" 带有指定缓存权限的秒数。")])])]),t._v(" "),a("li",[t._v("然后，发出实际请求，应用先前的“简单”方案。")])]),t._v(" "),a("br"),t._v(" "),a("br"),t._v(" "),a("br")])},[],!1,null,null,null);e.default=r.exports},699:function(t,e,s){t.exports=s.p+"assets/img/xhr-another-domain.046a9aa8.svg"},700:function(t,e,s){t.exports=s.p+"assets/img/xhr-preflight.a71c6da1.svg"}}]);