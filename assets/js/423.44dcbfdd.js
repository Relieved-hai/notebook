(window.webpackJsonp=window.webpackJsonp||[]).push([[423],{1066:function(s,e,a){"use strict";a.r(e);var t=a(19),n=Object(t.a)({},function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"一、forever"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、forever","aria-hidden":"true"}},[s._v("#")]),s._v(" 一、forever")]),s._v(" "),a("blockquote",[a("p",[a("code",[s._v("forever")]),s._v("则可以在"),a("code",[s._v("cmd")]),s._v("或"),a("code",[s._v("ssh")]),s._v("连接断开时,让项目一直运行,而且可以在项目崩溃时自动重启")])]),s._v(" "),a("ul",[a("li",[s._v("安装 "),a("code",[s._v("npm install -g forever")])]),s._v(" "),a("li",[a("code",[s._v("forever")]),s._v("的帮助手册  "),a("code",[s._v("forever --help")])]),s._v(" "),a("li",[s._v("使用"),a("code",[s._v("forever")]),s._v("启动项目 "),a("code",[s._v("forever start app.js")])]),s._v(" "),a("li",[s._v("使用"),a("code",[s._v("forever")]),s._v("停止项目 "),a("code",[s._v("forever stop app.js")])]),s._v(" "),a("li",[s._v("列出所有通过"),a("code",[s._v("forever")]),s._v("管理的项目 "),a("code",[s._v("forever list")])]),s._v(" "),a("li",[s._v("监视项目中的文件,当文件有变动时重启项目 "),a("code",[s._v("forever -w start app.js")])])]),s._v(" "),a("br"),s._v(" "),a("h2",{attrs:{id:"二、pm2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、pm2","aria-hidden":"true"}},[s._v("#")]),s._v(" 二、pm2")]),s._v(" "),a("blockquote",[a("p",[s._v("部署参考 http://blog.poetries.top/2018/11/18/react-ssr-next-deploy/")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm install pm2 -g\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("新建一份index.js测试，运行以下命令测试")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start index.js\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("运行")])]),s._v(" "),a("blockquote",[a("p",[s._v("你可以执行以下命令来重启和暂停服务")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 stop     <app_name|id|'all'|json_conf>\npm2 restart  <app_name|id|'all'|json_conf>\npm2 delete   <app_name|id|'all'|json_conf>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("blockquote",[a("p",[s._v("比如"),a("code",[s._v("pm2 stop index.js")]),s._v("，暂停上面的"),a("code",[s._v("index.js")]),s._v("服务")])]),s._v(" "),a("p",[a("strong",[s._v("常用命令")])]),s._v(" "),a("ul",[a("li",[s._v("运行"),a("code",[s._v("pm2 start app.js")])]),s._v(" "),a("li",[s._v("查看运行状态 "),a("code",[s._v("pm2 list")])]),s._v(" "),a("li",[s._v("追踪资源运行情况 "),a("code",[s._v("pm2 monit")])]),s._v(" "),a("li",[s._v("查看日志 "),a("code",[s._v("pm2 logs")])]),s._v(" "),a("li",[s._v("重启应用 "),a("code",[s._v("pm2 restart appId")])]),s._v(" "),a("li",[s._v("停止应用  "),a("code",[s._v("pm2 stop app.js")])]),s._v(" "),a("li",[s._v("开启"),a("code",[s._v("api")]),s._v("访问 "),a("code",[s._v("pm2 web")])])]),s._v(" "),a("p",[a("strong",[s._v("自动重启")])]),s._v(" "),a("p",[s._v("当文件改动则自动重启服务")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start app.js --watch\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("这里是监控整个项目的文件，如果只想监听指定文件和目录，建议通过下面配置文件的"),a("code",[s._v("watch")]),s._v("、"),a("code",[s._v("ignore_watch")]),s._v("字段来设置")]),s._v(" "),a("p",[a("strong",[s._v("配置文件")])]),s._v(" "),a("p",[s._v("编写一份"),a("code",[s._v("ecosystem.json")]),s._v("文件，完整配置说明请参考官方文档")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{\n    "name": "test", // 应用名称\n    "script": "./bin/www", // 实际启动脚本\n    "cwd": "./", // 当前工作路径\n    "watch": [ // 监控变化的目录，一旦变化，自动重启\n        "bin",\n        "routers"\n    ],\n    "ignore_watch": [ // 从监控目录中排除\n        "node_modules",\n        "logs",\n        "public"\n    ],\n    "watch_options": {\n        "followSymlinks": false\n    },\n    "max_memory_restart": "100M", //超过最大内存重启\n    "error_file": "./logs/app-err.log", // 错误日志路径\n    "out_file": "./logs/app-out.log", // 普通日志路径\n    "env": {\n        "NODE_ENV": "production" // 环境参数，当前指定为生产环境\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("配置完后你可以执行以下命令")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Start all apps")]),s._v("\npm2 start ecosystem.json\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Stop")]),s._v("\npm2 stop ecosystem.json\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Restart")]),s._v("\npm2 start ecosystem.json\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Or")]),s._v("\npm2 restart ecosystem.json\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Reload")]),s._v("\npm2 reload ecosystem.json\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Delete from PM2")]),s._v("\npm2 delete ecosystem.json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("这里注意的是配置文件改变了之后要先"),a("code",[s._v("delete")]),s._v("再"),a("code",[s._v("start")]),s._v("配置文件才能生效")]),s._v(" "),a("p",[a("strong",[s._v("负载均衡")])]),s._v(" "),a("p",[s._v("命令如下，表示开启三个进程。如果-i 0，则会根据机器当前核数自动开启尽可能多的进程")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start app.js -i 3      //开启三个进程\npm2 start app.js -i max //根据机器CPU核数，开启对应数目的进程\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("日志查看")])]),s._v(" "),a("p",[s._v("除了可以打开日志文件查看日志外，还可以通过pm2 logs来查看实时日志。这点对于线上问题排查非常重要")]),s._v(" "),a("p",[s._v("比如某个node服务突然异常重启了，那么可以通过pm2提供的日志工具来查看实时日志，看是不是脚本出错之类导致的异常重启。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 logs\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("内存使用超过上限自动重启")])]),s._v(" "),a("blockquote",[a("p",[s._v("如果想要你的应用，在超过使用内存上限后自动重启，那么可以加上"),a("code",[s._v("--max-memory-restart")]),s._v("参数。（有对应的配置项）")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start big-array.js --max-memory-restart 20M\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("pm2与forever对比")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Feature")]),s._v(" "),a("th",[s._v("Forever")]),s._v(" "),a("th",[s._v("PM2")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("Keep Alive")]),s._v(" "),a("td",[s._v("✔")]),s._v(" "),a("td",[s._v("✔")])]),s._v(" "),a("tr",[a("td",[s._v("Coffeescript")]),s._v(" "),a("td",[s._v("✔")]),s._v(" "),a("td")]),s._v(" "),a("tr",[a("td",[s._v("Log aggregation")]),s._v(" "),a("td"),s._v(" "),a("td",[s._v("✔")])]),s._v(" "),a("tr",[a("td",[s._v("API")]),s._v(" "),a("td"),s._v(" "),a("td",[s._v("✔")])]),s._v(" "),a("tr",[a("td",[s._v("Terminal monitoring")]),s._v(" "),a("td"),s._v(" "),a("td",[s._v("✔")])]),s._v(" "),a("tr",[a("td",[s._v("Clustering")]),s._v(" "),a("td"),s._v(" "),a("td",[s._v("✔")])]),s._v(" "),a("tr",[a("td",[s._v("JSON configuration")]),s._v(" "),a("td"),s._v(" "),a("td",[s._v("✔")])])])])])},[],!1,null,null,null);e.default=n.exports}}]);